%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Let expressions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

-- generated from ruler rules into EHRulerRules, was 1.Let
%%[(5 hmtyinfer).Let
SEM Expr
  | Let         loc         .   gathTySigGam_l_     =   @decls.gathTySigGam
                decls       .   patValGam           =   gamPushGam @gathTySigGam_l_ @lhs.valGam
                loc         .   (valGam_l_,valGam_g_)
                                                    =   gamPop @decls.patValGam
                decls       .   valGam              =   @decls.patValGam
                body        .   valGam              =   @decls.patValGam
%%]

-- generated from ruler rules into EHRulerRules, was 2.Let
%%[(5 hmtyinfer).Let
SEM Expr
  | Let         decls       .   patTyVarMp          =   @lhs.tyVarMp
                            .   tyVarMp             =   @decls.patTyVarMp
%%]

-- generated from ruler rules into EHRulerRules, was 3.Let
-- 20080212, AD: incompatible because of addition of marked lines, for lexically scoped type variables
%%[(5 hmtyinfer).Let
SEM Expr
  | Let         (loc.lSubsValGam_,loc.cycTyVarMp_l) =   @decls.tyVarMp |==> @valGam_l_
                (loc.gSubsValGam_,loc.cycTyVarMp_g) =   @decls.tyVarMp |==> @valGam_g_
                loc         .   gTyTvL              =   ftv @gSubsValGam_
                                                        ++ ftv (@decls.tyVarMp |=> @lhs.tyGam)      -- 20080212 incompatibility with ruler version
                            .   quValGam_           =   valGamQuantify @gTyTvL @lSubsValGam
                body        .   valGam              :=  gamPushGam @quValGam_ @gSubsValGam_
%%]

-- generated from ruler rules into EHRulerRules, was 4.Let
%%[(5 hmtyinfer).Let
SEM Expr
  | Let         loc         .   gathTySigGam_l_     :=  valGamInst1Exists @lUniq @decls.gathTySigGam
                loc         .   quValGam_ex_        :=  valGamInst1Exists @lUniq2 $ valGamQuantify @gTyTvL $ @lSubsValGam_
                            .   quValGam_           :=  emptyGam
                body        .   valGam              :=  gamPushGam @quValGam_ex_ @gSubsValGam_
                loc         .   lUniq               :   UNIQUEREF gUniq
                loc         .   lUniq2              :   UNIQUEREF gUniq
%%]

%%[(9 hmtyinfer)
SEM Expr
  | Let         loc         .   (quValGam_ex_,tqoGam)
                                                    :=  let  (vg,tqog) = valGamQuantify @gTyTvL @quantPrOccL @lSubsValGam_
                                                        in   (valGamInst1Exists @lUniq2 vg,tqog)
                            .   tmpoTyVarMp         =   foldr (\tmpo c -> tmpoImplsVarMp tmpo |=> c) emptyVarMp (gamElts @tqoGam)
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Known type and instantiation required
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

-- generated from ruler rules into EHRulerRules, was 1.tyInstKnown
%%[(5 hmtyinfer).tyInstKnown
SEM Decl
  | Val         loc         .   knTy                =   @ty_sig_
%%]

-- generated from ruler rules into EHRulerRules, was 2.tyInstKnown
%%[(5 hmtyinfer).tyInstKnown
SEM Decl
  | Val         expr        .   knTy                =   if @hasTySig then @knTy else @patExpr.ty
%%]

-- generated from ruler rules into EHRulerRules, was 3.tyInstKnown
%%[(5 hmtyinfer).tyInstKnown
SEM Decl
  | Val         loc         .   knTy                :=  tyInstKnown @lUniq @ty_sig_
                loc         .   lUniq               :   UNIQUEREF gUniq
%%]

-- generated from ruler rules into EHRulerRules, was 4.tyInstKnown
%%[(5 hmtyinfer).tyInstKnown
SEM Decl
  | Val         loc         .   knTy                :=  @ty_sig_
%%]

%%[(9 hmtyinfer).tyInstKnown
%%]

SEM Decl
  | Val         expr        .   knTy                :=  if @hasTySig  then @knTy
                                                                      else [mkImplsVar @lUniq2] `mkArrow` @patExpr.ty

%%[(94 hmtyinfer)
SEM Decl
  | FFE         loc         .   knTy                =   @ty_sig_
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Final type
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(2 hmtyinfer).finValGam
ATTR AllDecl [ finValGam: ValGam | | ]
ATTR AllNT [ finTyVarMp: VarMp | | ]

SEM Expr
  | Let         loc         .   finValGamDecls      =   @lhs.finTyVarMp |=> (gamTop @decls.patValGam)
                decls       .   finValGam           =   @finValGamDecls

SEM Decl
  | TySig       loc         .   finalTy             =   vgiTy $ fromJust
                                                        $ valGamLookup @nm $ @lhs.finValGam

SEM AGItf
  | AGItf       expr        .   finTyVarMp          =   @expr.tyVarMp
%%]

%%[(3 hmtyinfer).finValGam
SEM Expr
  | Let         loc         .   finValGamDecls      :=  @lhs.finTyVarMp |=> @quValGam_
%%]

%%[(4 hmtyinfer).finValGam
SEM Expr
  | Let         loc         .   finValGamDecls      :=  @lhs.finTyVarMp |=> @quValGam_ex_
%%]

%%[(9 hmtyinfer)
SEM Expr
  | Let         loc         .   finTyVarMp          =   @tmpoTyVarMp |=> @lhs.finTyVarMp
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Final kind
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(7 hmtyinfer).finTyGam
ATTR AllNT [ finKiVarMp: VarMp | | ]

SEM AGItf
  | AGItf       expr        .   finKiVarMp          =   @expr.kiVarMp
%%]

%%[(7 hmtyinfer)
ATTR AllNT [ finTyKiGam: TyKiGam |  | ]

SEM AGItf
  | AGItf       expr        .   finTyKiGam          =   emptyGam

SEM Expr
  | Let         loc         .   finTyKiGam          =   @lhs.finKiVarMp |=> @decls.patTyKiGam

%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Known kind
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(6 hmtyinfer)
SEM Decl
  | Data
%%[[11
    Type
%%]]
                loc         .   knKi                =   @sigKi
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Type inferencing, decls, top level, abstraction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(1 hmtyinfer).valGam
ATTR
  AllDecl AllExpr
%%[[5
  AllDataConstr AllCase
%%]]
    [ valGam: ValGam | | ]
ATTR AllPatExpr [ | valGam: ValGam | ]
%%]

%%[(1 hmtyinfer).initValGam
SEM AGItf   
  | AGItf       expr        .   valGam              =   emptyGam
%%]

%%[(20 hmtyinfer) -1.initValGam
ATTR AGItf [ valGam: ValGam | | ]

SEM AGItf
  | AGItf       loc         .   valGam              =   @lhs.valGam
%%]

%%[(1 hmtyinfer).patValGam
ATTR AllDecl [ | patValGam: ValGam | ]
%%]

-- generated from ruler rules into EHRulerRules, was 1.patValGam.Val
%%[(5 hmtyinfer).patValGam.Val
SEM Decl
  | Val         patExpr     .   valGam              =   @lhs.patValGam
                lhs         .   patValGam           =   @patExpr.valGam
                expr        .   valGam              =   @lhs.valGam
%%]

%%[(2 hmtyinfer).tyVarMp
ATTR AllDecl [ | tyVarMp: VarMp  patTyVarMp: VarMp | ]

SEM AGItf
  | AGItf       expr        .   tyVarMp             =   emptyVarMp
%%]

%%[(5 hmtyinfer)
ATTR AllCase [ | tyVarMp: VarMp | ]
%%]

-- generated from ruler rules into EHRulerRules, was 2.tyVarMp.Val
%%[(5 hmtyinfer).tyVarMp.Val
SEM Decl
  | Val         patExpr     .   tyVarMp             =   @lhs.patTyVarMp
                lhs         .   patTyVarMp          =   @patExpr.tyVarMp
                expr        .   tyVarMp             =   @lhs.tyVarMp
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Kind inferencing, decls, top level, abstraction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Decl should merge with one in InferTyExpr

%%[(1 hmtyinfer).tyGam
ATTR AllDecl AllExpr [ tyGam: TyGam | | ]
%%]

%%[(4 hmtyinfer)
ATTR AllPatExpr [ | tyGam: TyGam | ]
%%]

%%[(5 hmtyinfer)
ATTR AllDataConstr AllCase [ tyGam: TyGam | | ]
ATTR AllDecl [ | patTyGam: TyGam | ]
%%]

%%[(5 hmtyinfer)
SEM Expr
  | Let         decls       .   patTyGam            =   gamPushNew @lhs.tyGam
                            .   tyGam               =   @decls.patTyGam
%%]

%%[(7 hmtyinfer)
ATTR AllDataField [ | tyGam: TyGam | ]
%%]

%%[(16 hmtyinfer)
ATTR AllDataConstrEq [ | tyGam: TyGam | ]

-- tyvarid of .tyVar already present in @lhs.tyGam
SEM DataConstrEq
  | Eq  tyExpr.tyGam = @lhs.tyGam
%%]

%%[(50 hmtyinfer)
ATTR AllDataConstrEq [ | tyGam: TyGam | ]
%%]

%%[(6 hmtyinfer)
ATTR AllDecl AllExpr AllDataConstr AllCase [ tyKiGam: TyKiGam | | ]
ATTR
  AllPatExpr
%%[[7
  AllDataField
%%]]
%%[[16
  AllDataConstrEq
%%]]
    [ | tyKiGam: TyKiGam | ]
%%]

%%[(6 hmtyinfer)
ATTR AllDecl [ | patTyKiGam: TyKiGam | ]
%%]

%%[(6 hmtyinfer)
ATTR AllExpr AllPatExpr AllData AllCase AllDecl [ | kiVarMp: VarMp | ]
ATTR AllDecl [ | patKiVarMp: VarMp | ]
%%]

%%[(6 hmtyinfer)
SEM Expr
  | Let         decls       .   patTyGam            :=  gamPushGam @decls.gathKiSigGam @lhs.tyGam
                            .   patTyKiGam          =   gamPushGam @decls.gathTyKiSigGam @lhs.tyKiGam
                            .   patKiVarMp          =   @lhs.kiVarMp
                loc         .   (tyGam_l_,tyGam_g_) =   gamPop @decls.patTyGam
                            .   (tyKiGam_l_,tyKiGam_g_)
                                                    =   gamPop @decls.patTyKiGam
                decls       .   tyGam               :=  gamPushGam @tyGam_l_ @lhs.tyGam
                            .   tyKiGam             =   gamPushGam @tyKiGam_l_ @lhs.tyKiGam
                            .   kiVarMp             =   @decls.patKiVarMp
                loc         .   (lSubsTyKiGam,cycTyKiVarMp_l)
                                                    =   @decls.kiVarMp |==> @tyKiGam_l_
                            .   (gSubsTyKiGam,cycTyKiVarMp_g)
                                                    =   @decls.kiVarMp |==> @tyKiGam_g_
                            .   gKiTvL              =   ftv @gSubsTyKiGam
                            .   lQuTyGam            =   {- @decls.tyVarMp |=> -} @tyGam_l_
                            .   lQuTyKiGam          =   tyKiGamInst1Exists @lUniq3 $ tyKiGamQuantify @gKiTvL $ @lSubsTyKiGam
                body        .   tyGam               =   gamAddGam @lQuTyGam @tyGam_g_
                            .   tyKiGam             =   gamAddGam @lQuTyKiGam @gSubsTyKiGam
                loc         .   lUniq3              :   UNIQUEREF gUniq
%%]

%%[(6 hmtyinfer)
SEM Decl
  | TySig       tyExpr      .   tyGam               =   gamPushNew @lhs.tyGam
                            .   tyKiGam             =   gamPushNew @lhs.tyKiGam
                loc         .   fo_                 =   fitsIn weakFIOpts emptyFE @lUniq2 @tyExpr.kiVarMp @tyExpr.ki kiStar
                lhs         .   kiVarMp             =   foVarMp @fo_ |=> @tyExpr.kiVarMp
                loc         .   lUniq2              :   UNIQUEREF gUniq
%%]

%%[(11 hmtyinfer)
ATTR AllDecl [ | tyTyVarMp: VarMp | ]

SEM Expr
  | Let         decls       .   tyTyVarMp           =   emptyVarMp
                loc         .   lQuTyGam            :=  @decls.tyTyVarMp |=> @tyGam_l_
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Gamma/Environment for fitting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(98 hmtyinfer)
SEM AGItf
  | AGItf       loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @predScope
                                                            , feTyGam = @expr.gathTyGam
                                                            , fePolGam = @expr.gathPolGam
%%[[99
                                                            , feRange = emptyRange
%%]]
                                                            }
%%]

%%[(4 hmtyinfer).Decl.fe
SEM Decl
  | *           loc         .   fe                  =   emptyFE
%%]

%%[(11 hmtyinfer) -4.Decl.fe
SEM Decl
  | *           loc         .   fe                  =   emptyFE
                                                            { feTyGam = @lhs.tyGam
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]

%%[(9 hmtyinfer)
SEM Decl
  | Instance    loc         .   fe                  :=  emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
                            .   fe2                 =   emptyFE
%%[[11
                                                            { feTyGam = @lhs.tyGam
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]]
%%]

%%[(4 hmtyinfer).FIEnv
SEM Expr
  | *           loc         .   fe                  =   emptyFE
%%]

%%[(7 hmtyinfer).FIEnv
SEM RecExpr
  | *           loc         .   fe                  =   emptyFE

SEM DataFieldExpr
  | *           loc         .   fe                  =   emptyFE
%%]

%%[(9 hmtyinfer).FIEnv -(4.FIEnv 7.FIEnv)
SEM Expr
  | Let         loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
  | Lam AppTop
%%[[12
    LamImpl
%%]]
                loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
  | * - Lam AppTop Let
%%[[12
    LamImpl
%%]]
                loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }

SEM RecExpr
  | *           loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }

SEM DataFieldExpr
  | *           loc         .   fe                  =   emptyFE
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]

%%[(4 hmtyinfer)
SEM PatExpr
  | *           loc         .   fe                  =   emptyFE
%%[[9
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]]
%%]

%%[(7 hmtyinfer)
SEM RecPatExpr
  | *           loc         .   fe                  =   emptyFE
%%[[9
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]]
%%]

%%[(7 hmtyinfer)
SEM DataFieldPatExpr
  | *           loc         .   fe                  =   emptyFE
%%[[9
                                                            { feEHCOpts = @lhs.opts
                                                            , fePredScope = @lhs.predScope
%%[[11
                                                            , feTyGam = @lhs.tyGam
%%]]
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
%%[[99
                                                            , feRange = @range
%%]]
                                                            }
%%]]
%%]

%%[(4 hmtyinfer)
SEM TyExpr
  | *           loc         .   fe                  =   emptyFE
%%]

%%[(9 hmtyinfer)
SEM PrExpr
  | *           loc         .   fe2                 =   emptyFE
%%[[11
                                                            { feTyGam = @lhs.tyGam
%%[[17
                                                            , fePolGam = @lhs.polGam
%%]]
                                                            }
%%]]
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Id of case
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(8 hmtyinfer codegen)
SEM Expr
  | Case        loc         .   caseIds     =   maybe (Set.singleton uidStart) id @mbCaseIds
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% RCEEnv (primarily for ToCore)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(8 hmtyinfer codegen)
SEM Expr
  | Lam Sel DataFields
%%[[12
    LamImpl
%%]]
                loc         .   rceEnv      =   (emptyRCEEnv @lhs.opts) { rceValGam = @lhs.valGam, rceDataGam = @lhs.dataGam }
  | Case        loc         .   rceEnv      =   (emptyRCEEnv @lhs.opts)
                                                            { rceValGam  = @lhs.valGam, rceDataGam = @lhs.dataGam
                                                            , rceCaseIds = @caseIds
                                                            }
%%]

%%[(8 hmtyinfer codegen)
SEM PatExpr
  | AppTop Rec DataFields
                loc         .   rceEnv      =   (emptyRCEEnv @lhs.opts) { rceValGam = @lhs.valGam, rceDataGam = @lhs.dataGam }
%%]

%%[(8 hmtyinfer codegen)
SEM Decl
  | Data        loc         .   rceEnv      =   (emptyRCEEnv @lhs.opts) { rceValGam = @lhs.valGam, rceDataGam = @lhs.dataGam }
%%]

%%[(95 hmtyinfer codegen)
SEM Decl
  | Instance    loc         .   rceEnv      =   (emptyRCEEnv @lhs.opts) { rceValGam = @lhs.valGam, rceDataGam = @lhs.dataGam }
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Init of tyGam
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(20 hmtyinfer)
ATTR AGItf [ tyGam: TyGam | | ]
%%]

%%[(1 hmtyinfer).initTyGam
SEM AGItf
%%[[1
  | AGItf       loc         .   tyGam               =   initTyGam
%%][20
  | AGItf       loc         .   tyGam               =   @lhs.tyGam
%%]]
%%]

This is not maintained w.r.t. tyKiGam:

%%[(7_2 hmtyinfer).initTyGam -1.initTyGam
SEM AGItf
  | AGItf       loc         .   tyGam               :=  assocLToGam
                                                          [ (hsnArrow       , mkTGI (Ty_Con hsnArrow) ([kiStar,kiStar] `mkArrow` kiStar))
                                                          , (hsnInt         , mkTGI tyInt kiStar)
                                                          , (hsnChar        , mkTGI tyChar kiStar)
                                                          , (hsnRow         , mkTGI (Ty_Con hsnUnknown) kiRow)
                                                          , (hsnRec         , mkTGI (Ty_Con hsnRec) ([kiRow] `mkArrow` kiStar))
                                                          , (hsnSum         , mkTGI (Ty_Con hsnSum) ([kiRow] `mkArrow` kiStar))
                                                          , (hsnRowEmpty    , mkTGI (Ty_Con hsnRowEmpty) kiRow)
                                                          , (hsnRow         , mkTGI (Ty_Con hsnUnknown) kiRow)
                                                          , (hsnRec         , mkTGI (Ty_Con hsnRec) ([kiRow] `mkArrow` kiStar))
                                                          , (hsnSum         , mkTGI (Ty_Con hsnSum) ([kiRow] `mkArrow` kiStar))
                                                          , (hsnRowEmpty    , mkTGI (Ty_Con hsnRowEmpty) kiRow)
                                                          ]
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Init of tyKiGam
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This is incomplete for variant 7_2.

%%[(6 hmtyinfer).initTyKiGam
SEM AGItf
  | AGItf       loc         .   tyKiGam             =   initTyKiGam
%%]

%%[(20 hmtyinfer) -6.initTyKiGam
ATTR AGItf [ tyKiGam: TyKiGam | | ]

SEM AGItf
  | AGItf       loc         .   tyKiGam             =   @lhs.tyKiGam
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Init of polGam
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  Environment with final polarities for all type constructors that are yet in scope. The
  final polarities for type construtors of data type declarations of a Let are added to
  the polGam of the body of the Let.
  
  In other words: the polGam changes on the way down!

%%[(17 hmtyinfer).initPolGam
SEM AGItf
  | AGItf       loc         .   polGam              =   initPolGam
%%]

%%[(20 hmtyinfer) -17.initPolGam
ATTR AGItf [ polGam: PolGam | | ]

SEM AGItf
  | AGItf       loc         .   polGam              =   @lhs.polGam
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Sort, but no inferencing && etc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(6 hmtyinfer)
ATTR AllExpr AllTyExpr AllPatExpr AllData AllCase AllDecl [ kiGam: KiGam | | ]
%%]

%%[(6 hmtyinfer)
SEM AGItf
  | AGItf       loc         .   kiVarMp             =   emptyVarMp
%%]

%%[(6 hmtyinfer).initKiGam
SEM AGItf
  | AGItf       loc         .   kiGam               =   initKiGam       -- fake dependency for uuagc --cycle
%%]

%%[(20 hmtyinfer) -6.initKiGam
ATTR AGItf [ kiGam: KiGam | | ]

SEM AGItf
  | AGItf       loc         .   kiGam               =   @lhs.kiGam
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Type signatures
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(1 hmtyinfer).gathTySigGam
ATTR AllDecl [ | | gathTySigGam USE {`gamAddGam`} {emptyGam}: ValGam ]
%%]

%%[(1 hmtyinfer)
%%]
SEM Decls
  | Cons        lhs         .   gathTySigGam        =   @hd.gathTySigGam `gamAddGam` @tl.gathTySigGam

-- generated from ruler rules into EHRulerRules, was 1.gamSigTyGath
%%[(5 hmtyinfer).gamSigTyGath
SEM Decl
  | TySig       loc         .   gamSigTy            =   @tyExpr.ty
                            .   gathTySigGam        =   @nm `gamSingleton` ValGamInfo @gamSigTy
%%]
SEM Expr
  | Let         decls       .   gathTySigGam        =   emptyGam

%%[(1 hmtyinfer).tySigGam
ATTR AllDecl AllPatExpr [ tySigGam: ValGam | | ]
%%]

%%[(1 hmtyinfer)
SEM Expr
  | Lam
%%[[12
    LamImpl
%%]]
                loc         .   tySigGam            =   emptyGam
%%]

%%[(5 hmtyinfer)
SEM CaseAlt
  | Pat         loc         .   tySigGam            =   emptyGam
%%]

-- generated from ruler rules into EHRulerRules, was 1.tySigGam.TysigLet
%%[(5 hmtyinfer).tySigGam.TysigLet
SEM Expr
  | Let         decls       .   tySigGam            =   @decls.gathTySigGam
%%]

-- generated from ruler rules into EHRulerRules, was 1.tySigGam.Val
%%[(5 hmtyinfer).tySigGam.Val
SEM Decl
  | Val         loc         .   (ty_sig_,hasTySig)  =   case @patExpr.mbTopNm of
                                                          Nothing
                                                            ->  (Ty_Any,False)
                                                          Just nm
                                                            ->  case gamLookup nm @lhs.tySigGam of
                                                                  Nothing   -> (Ty_Any,False)
                                                                  Just vgi  -> (vgiTy vgi,True)
%%]

-- generated from ruler rules into EHRulerRules, was 3.TySig
%%[(5 hmtyinfer).TySig
SEM Decl
  | TySig       loc         .   ty_sig_             =   tyQuantify (`elem` @tyExpr.tyVarWildL) @tyExpr.ty
                            .   gamSigTy            :=  @ty_sig_
%%]

%%[(6 hmtyinfer)
SEM Decl
  | TySig       loc         .   gTyTvL              =   ftv . map (tgiTy.snd) . gamToAssocL $ @lhs.tyGam
                            .   ty_sig_             :=  tyQuantify (`elem` (@tyExpr.tyVarWildL ++ @gTyTvL)) @tyExpr.ty
%%]

%%[(8 hmtyinfer)
SEM Decl
  | FFI
%%[[94
    FFE
%%]]
                loc         .   ty_sig_             =   tyQuantifyClosed @tyExpr.ty
%%[[8
                            .   ty_sig_expanded     =   @ty_sig_
%%][11
                            .   ty_sig_expanded     =   tyCanonic (emptyFI {fiEnv = @fe}) @ty_sig_
%%]]
                lhs         .   gathTySigGam        =   @nm `gamSingleton` ValGamInfo @ty_sig_
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Kind signatures
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(6 hmtyinfer).kiSigGam
ATTR AllDecl [ kiSigGam: TyGam | gathKiSigGam: TyGam | ]

SEM Expr
  | Let         decls       .   gathKiSigGam        =   emptyGam
                            .   kiSigGam            =   @decls.gathKiSigGam

SEM Decl
  | KiSig       lhs         .   gathKiSigGam        =   gamAdd @nm (mkTGI (Ty_Con @nm)) @lhs.gathKiSigGam
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Kind signatures (based on TyKiGam)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

20070529: Not finished

%%[(6 hmtyinfer)
ATTR AllDecl [ tyKiSigGam: TyKiGam | | gathTyKiSigGam USE {`gamUnion`} {emptyGam}: TyKiGam ]

SEM Decl
  | KiSig       lhs         .   gathTyKiSigGam      =   tyKiGamNameSingleton @nm (TyKiGamInfo @sigKi)

SEM Expr
  | Let         decls       .   tyKiSigGam          =   @decls.gathTyKiSigGam
%%]

%%[(6 hmtyinfer)
SEM Decl
  | Data
%%[[11
    Type
%%]]
                loc         .   (sigKi,hasKiSig)    =   case tyKiGamLookupByName @tyNm @lhs.tyKiSigGam of
                                                          Nothing -> (Ty_Any,False)
                                                          Just i  -> (tkgiKi i,True)
%%]

%%[(6 hmtyinfer)
SEM Decl
  | KiSig       loc         .   sigKi               =   kiQuantify (const False) @kiExpr.ki
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Include binding for pattern var?
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(1 hmtyinfer).inclVarBind
ATTR PatExpr [ inclVarBind: Bool | | ]

SEM PatExpr
  | AppTop      patExpr     .   inclVarBind         =   True

SEM Decl
  | Val         patExpr     .   inclVarBind         =   False

SEM Expr
  | Lam         arg         .   inclVarBind         =   True
%%]

%%[(2 hmtyinfer)
SEM Decl
  | Val         patExpr     .   inclVarBind         :=  not @hasTySig
%%]

%%[(5 hmtyinfer)
SEM CaseAlt
  | Pat         patExpr     .   inclVarBind         =   True
%%]

%%[(7 hmtyinfer)
SEM RecPatExpr
  | Ext Expr    patExpr     .   inclVarBind         =   True

SEM DataFieldPatExpr
  | Ext         patExpr     .   inclVarBind         =   True
%%]

%%[(12 hmtyinfer)
SEM Expr
  | LamImpl     arg         .   inclVarBind         =   True
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% How to do subsumption
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(4 hmtyinfer).fiOpts.init
ATTR AllExpr AllPatExpr [ fiOpts: FIOpts | | ]

SEM AGItf
  | AGItf       expr        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

-- generated from ruler rules into EHRulerRules, was/from 4.fiOpts.init
%%[(5 hmtyinfer).fiOpts.init
SEM Expr
  | AppImpred   func        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                loc         .  argFIOpts            =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                arg         .  fiOpts               =   @argFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]                
%%]

-- generated from ruler rules into EHRulerRules, was 2.App
%%[(5 hmtyinfer).fiOpts.init
SEM Decl
  | Val
%%[[94
    FFE
%%]]
                expr        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
  | Val         patExpr     .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

-- generated from ruler rules into EHRulerRules, was 2.App
%%[(5 hmtyinfer).fiOpts.init
SEM Expr
  | Lam         loc         .  knFunFIOpts          =   (@lhs.fiOpts {fioBindRFirst=True }) 
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
  | App         func        .  fiOpts               =   @lhs.fiOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                loc         .  argFIOpts            =   instLFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                arg         .  fiOpts               =   @argFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
  | TypeAs      loc         .   knTyFIOpts          =   strongFIOpts
                            .   downFIOpts          =   strongFIOpts {fioBindLFirst = False}
%%]

-- 20070205 - AD, should be generated from ruler rules, but not yet is
%%[(5 hmtyinfer)
SEM Expr
  | TypeAs      loc         .  asFiOpts             =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                expr        .  fiOpts               =   @asFiOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%[(5 hmtyinfer)
ATTR AllCase [ fiOpts: FIOpts | | ]

SEM Decl
  | Val         expr        .  fiOpts               :=  (if @hasTySig then strongFIOpts else weakFIOpts)
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM CaseAlt
  | Pat         patExpr     .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM Expr
  | Case        expr        .  fiOpts              =   weakFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%[(7 hmtyinfer)
ATTR DataFieldExpr [ fldFIOpts: FIOpts | | ]

SEM RecExpr
  | Ext         loc         .  knFIOpts             =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
                recExpr     .  fiOpts               =   @lhs.fiOpts {fioNoRLabElimFor = @nm : fioNoRLabElimFor @lhs.fiOpts}
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
  | Upd         loc         .  knFIOpts             =   strongFIOpts -- {fioNoRLabElimFor = [@nm]}
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
  | Ext Upd     expr        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM Expr
  | DataFields  loc         .  fldFIOpts            =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM DataFieldExpr
  | Upd         expr        .  fiOpts               =   @lhs.fldFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM Expr
  | Rec         loc         .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%[(9 hmtyinfer)
SEM Expr
  | App         func        .  fiOpts               :=  implFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]

SEM Decl
  | InstanceIntro
                expr        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%[(12 hmtyinfer)
SEM Expr
  | AppImpl     arg         .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%[(1010 hmtyinfer)
SEM Decl
  | DynVal      expr        .  fiOpts               =   strongFIOpts
%%[[16
                                                          {fioFitVarFailureToProveObl = True }
%%]]
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Predicate env, for intro of predicates
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(9 hmtyinfer)
ATTR AllDecl [ | patClGam1: ClGam  patClGam2: ClGam | ]
ATTR NTPrf AllPrExpr AllTyExpr AllData AllPatExpr [ clGam: ClGam | | ]
%%]

%%[(9 hmtyinfer).initClGam
SEM AGItf
  | AGItf       loc         .   clGam               =   initClGam
%%]

%%[(20 hmtyinfer) -9.initClGam
ATTR AGItf [ clGam: ClGam | | ]

SEM AGItf
  | AGItf       loc         .   clGam               =   @lhs.clGam
%%]

%%[(9 hmtyinfer)
SEM Expr
  | Let         decls       .   patClGam1           =   gamPushNew @lhs.clGam
                            .   patClGam2           =   @decls.patClGam1
                loc         .   (lClGam,gClGam)     =   gamPop $ gamNoDups @decls.patClGam2
                decls       .   clGam               =   gamPushGam @lClGam @lhs.clGam
                body        .   clGam               =   gamPushGam @lClGam @gClGam
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Is let a first let in a sequence of lets?
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(9 hmtyinfer)
ATTR Expr [ isFirstLet: Bool | | ]

SEM CaseAlt
  | Pat         loc         .   isFirstLet          =   True

SEM DataFieldExpr
  | Expr Upd    loc         .   isFirstLet          =   True

SEM Decl
  | InstanceIntro Val
%%[[94
    FFE
%%]]
                loc         .   isFirstLet          =   True

SEM RecExpr
  | Expr Ext Upd
                loc         .   isFirstLet          =   True

SEM AGItf
  | AGItf       loc         .   isFirstLet          =   True

SEM Expr
  | Let         loc         .   isFirstLet          =   False
%%]

%%[(97 hmtyinfer)
SEM PatExpr
  | Expr        loc         .   isFirstLet          =   True

%%]

